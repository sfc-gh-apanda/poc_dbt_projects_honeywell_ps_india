-- ═══════════════════════════════════════════════════════════════════════════════
-- O2C ENHANCED - SAMPLE TEST DATA SETUP
-- ═══════════════════════════════════════════════════════════════════════════════
-- 
-- Purpose: Create and populate source tables for testing all 5 data load patterns
-- 
-- Tables Created:
--   EDW.CORP_MASTER.DIM_CUSTOMER       - Customer master data
--   EDW.CORP_MASTER.DIM_PAYMENT_TERMS  - Payment terms reference
--   EDW.CORP_MASTER.DIM_BANK_ACCOUNT   - Bank account master
--   EDW.CORP_TRAN.FACT_SALES_ORDERS    - Sales orders (multi-source)
--   EDW.CORP_TRAN.FACT_INVOICES        - Customer invoices
--   EDW.CORP_TRAN.FACT_PAYMENTS        - Payment transactions
-- 
-- Source Systems Included:
--   - BRP900 (North America ERP)
--   - CIP900 (Europe ERP)
--   - EEP300 (Asia Pacific ERP)
-- 
-- Prerequisites:
--   - Database EDW must exist
--   - Run with ACCOUNTADMIN or SYSADMIN
-- 
-- Idempotent: YES - Safe to run multiple times (uses CREATE OR REPLACE)
-- ═══════════════════════════════════════════════════════════════════════════════

USE ROLE SYSADMIN;
USE DATABASE EDW;
USE WAREHOUSE COMPUTE_WH;

-- ═══════════════════════════════════════════════════════════════════════════════
-- STEP 1: CREATE SOURCE SCHEMAS
-- ═══════════════════════════════════════════════════════════════════════════════

CREATE SCHEMA IF NOT EXISTS CORP_TRAN
    COMMENT = 'Corporate transactional data - Orders, Invoices, Payments';

CREATE SCHEMA IF NOT EXISTS CORP_MASTER
    COMMENT = 'Corporate master data - Customers, Payment Terms, Banks';

SELECT '✅ STEP 1 COMPLETE: Source schemas created' AS status;

-- ═══════════════════════════════════════════════════════════════════════════════
-- STEP 2: CREATE MASTER DATA TABLES
-- ═══════════════════════════════════════════════════════════════════════════════

-- ───────────────────────────────────────────────────────────────────────────────
-- DIM_CUSTOMER - Customer Master Data
-- ───────────────────────────────────────────────────────────────────────────────
CREATE OR REPLACE TABLE CORP_MASTER.DIM_CUSTOMER (
    CUSTOMER_NUM_SK VARCHAR(50),
    SOURCE_SYSTEM VARCHAR(20),
    CUSTOMER_NAME VARCHAR(255),
    CUSTOMER_TYPE VARCHAR(1),
    CUSTOMER_COUNTRY VARCHAR(2),
    CUSTOMER_COUNTRY_NAME VARCHAR(100),
    CUSTOMER_CLASSIFICATION VARCHAR(50),
    CUSTOMER_ACCOUNT_GROUP VARCHAR(10),
    DUNS_NUMBER VARCHAR(20),
    MDM_CUSTOMER_GLOBAL_ULTIMATE_DUNS VARCHAR(20),
    MDM_CUSTOMER_GLOBAL_ULTIMATE_NAME VARCHAR(255),
    MDM_CUSTOMER_FULL_NAME VARCHAR(255),
    LOAD_TS TIMESTAMP_NTZ,
    UPDATE_TS TIMESTAMP_NTZ
) COMMENT = 'Customer master data';

INSERT INTO CORP_MASTER.DIM_CUSTOMER
SELECT * FROM VALUES
    -- BRP900 Customers (North America)
    ('CUST-BRP-001', 'BRP900', 'Acme Corporation', 'E', 'US', 'United States', 'KEY_ACCOUNT', 'Z001', '123456789', '123456789', 'Acme Corporation', 'Acme Corporation', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('CUST-BRP-002', 'BRP900', 'GlobalTech Industries', 'E', 'US', 'United States', 'STRATEGIC', 'Z001', '234567890', '234567890', 'GlobalTech Industries', 'GlobalTech Industries', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('CUST-BRP-003', 'BRP900', 'Maple Manufacturing', 'E', 'CA', 'Canada', 'STANDARD', 'Z001', '345678901', '345678901', 'Maple Manufacturing', 'Maple Manufacturing', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('CUST-BRP-004', 'BRP900', 'Southwest Distributors', 'E', 'MX', 'Mexico', 'STANDARD', 'Z002', '456789012', '456789012', 'Southwest Distributors', 'Southwest Distributors', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    
    -- CIP900 Customers (Europe)
    ('CUST-CIP-001', 'CIP900', 'EuroMfg GmbH', 'E', 'DE', 'Germany', 'KEY_ACCOUNT', 'Z101', '111111111', '111111111', 'EuroMfg GmbH', 'EuroMfg GmbH', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('CUST-CIP-002', 'CIP900', 'Paris Industrielle SA', 'E', 'FR', 'France', 'STRATEGIC', 'Z101', '222222222', '222222222', 'Paris Industrielle SA', 'Paris Industrielle SA', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('CUST-CIP-003', 'CIP900', 'Nordic Components AB', 'E', 'SE', 'Sweden', 'STANDARD', 'Z102', '333333333', '333333333', 'Nordic Components AB', 'Nordic Components AB', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('CUST-CIP-004', 'CIP900', 'Italia Manufacturing', 'E', 'IT', 'Italy', 'STANDARD', 'Z102', '444444444', '444444444', 'Italia Manufacturing', 'Italia Manufacturing', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    
    -- EEP300 Customers (Asia Pacific)
    ('CUST-EEP-001', 'EEP300', 'Tokyo Electronics Ltd', 'E', 'JP', 'Japan', 'KEY_ACCOUNT', 'Z201', '555555555', '555555555', 'Tokyo Electronics Ltd', 'Tokyo Electronics Ltd', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('CUST-EEP-002', 'EEP300', 'Singapore Tech Pte', 'E', 'SG', 'Singapore', 'STRATEGIC', 'Z201', '666666666', '666666666', 'Singapore Tech Pte', 'Singapore Tech Pte', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('CUST-EEP-003', 'EEP300', 'Pacific Trading Co', 'E', 'AU', 'Australia', 'STANDARD', 'Z202', '777777777', '777777777', 'Pacific Trading Co', 'Pacific Trading Co', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('CUST-EEP-004', 'EEP300', 'Seoul Industries', 'E', 'KR', 'South Korea', 'STANDARD', 'Z202', '888888888', '888888888', 'Seoul Industries', 'Seoul Industries', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
AS t(CUSTOMER_NUM_SK, SOURCE_SYSTEM, CUSTOMER_NAME, CUSTOMER_TYPE, CUSTOMER_COUNTRY, CUSTOMER_COUNTRY_NAME, CUSTOMER_CLASSIFICATION, CUSTOMER_ACCOUNT_GROUP, DUNS_NUMBER, MDM_CUSTOMER_GLOBAL_ULTIMATE_DUNS, MDM_CUSTOMER_GLOBAL_ULTIMATE_NAME, MDM_CUSTOMER_FULL_NAME, LOAD_TS, UPDATE_TS);

-- ───────────────────────────────────────────────────────────────────────────────
-- DIM_PAYMENT_TERMS - Payment Terms Reference
-- ───────────────────────────────────────────────────────────────────────────────
CREATE OR REPLACE TABLE CORP_MASTER.DIM_PAYMENT_TERMS (
    PAYMENT_TERMS_CODE VARCHAR(10),
    SOURCE_SYSTEM VARCHAR(20),
    PAYMENT_TERMS_NAME VARCHAR(100),
    PAYMENT_TERMS_DESC VARCHAR(255),
    PAYMENT_TERMS_DAYS NUMBER(5,0),
    DISCOUNT_DAYS NUMBER(5,0),
    DISCOUNT_PERCENT NUMBER(5,2),
    LOAD_TS TIMESTAMP_NTZ,
    UPDATE_TS TIMESTAMP_NTZ
) COMMENT = 'Payment terms master data';

INSERT INTO CORP_MASTER.DIM_PAYMENT_TERMS
SELECT * FROM VALUES
    ('NET30', 'BRP900', 'Net 30 Days', 'Payment due within 30 days', 30, 10, 2.00, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('NET45', 'BRP900', 'Net 45 Days', 'Payment due within 45 days', 45, 10, 1.50, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('NET30', 'CIP900', 'Net 30 Days', 'Payment due within 30 days', 30, 10, 2.00, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('NET60', 'CIP900', 'Net 60 Days', 'Payment due within 60 days', 60, 15, 1.00, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('NET30', 'EEP300', 'Net 30 Days', 'Payment due within 30 days', 30, 10, 2.00, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('NET45', 'EEP300', 'Net 45 Days', 'Payment due within 45 days', 45, 10, 1.50, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
AS t(PAYMENT_TERMS_CODE, SOURCE_SYSTEM, PAYMENT_TERMS_NAME, PAYMENT_TERMS_DESC, PAYMENT_TERMS_DAYS, DISCOUNT_DAYS, DISCOUNT_PERCENT, LOAD_TS, UPDATE_TS);

-- ───────────────────────────────────────────────────────────────────────────────
-- DIM_BANK_ACCOUNT - Bank Account Master
-- ───────────────────────────────────────────────────────────────────────────────
CREATE OR REPLACE TABLE CORP_MASTER.DIM_BANK_ACCOUNT (
    BANK_ACCOUNT_ID VARCHAR(20),
    SOURCE_SYSTEM VARCHAR(20),
    BANK_NAME VARCHAR(255),
    BANK_CODE VARCHAR(20),
    BANK_COUNTRY VARCHAR(2),
    BANK_COUNTRY_NAME VARCHAR(100),
    BANK_ACCOUNT_TYPE VARCHAR(20),
    SWIFT_CODE VARCHAR(20),
    IBAN VARCHAR(50),
    BANK_ACCOUNT_NUMBER VARCHAR(50),
    LOAD_TS TIMESTAMP_NTZ,
    UPDATE_TS TIMESTAMP_NTZ
) COMMENT = 'Bank account master data';

INSERT INTO CORP_MASTER.DIM_BANK_ACCOUNT
SELECT * FROM VALUES
    ('BNK-BRP-001', 'BRP900', 'Chase Bank NA', 'JPMC', 'US', 'United States', 'HOUSE', 'CHASUS33', NULL, 'US-ACC-001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('BNK-BRP-002', 'BRP900', 'Bank of America', 'BOFA', 'US', 'United States', 'HOUSE', 'BOFAUS3N', NULL, 'US-ACC-002', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('BNK-CIP-001', 'CIP900', 'Deutsche Bank AG', 'DEUBA', 'DE', 'Germany', 'HOUSE', 'DEUTDEFF', 'DE89370400440532013000', 'EUR-ACC-001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('BNK-CIP-002', 'CIP900', 'BNP Paribas SA', 'BNPFR', 'FR', 'France', 'HOUSE', 'BNPAFRPP', 'FR1420041010050500013M02606', 'EUR-ACC-002', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('BNK-EEP-001', 'EEP300', 'DBS Bank Ltd', 'DBS', 'SG', 'Singapore', 'HOUSE', 'DBSSSGSG', NULL, 'SGD-ACC-001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
    ('BNK-EEP-002', 'EEP300', 'Mitsubishi UFJ', 'MUFJ', 'JP', 'Japan', 'HOUSE', 'BOTKJPJT', NULL, 'JPY-ACC-001', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
AS t(BANK_ACCOUNT_ID, SOURCE_SYSTEM, BANK_NAME, BANK_CODE, BANK_COUNTRY, BANK_COUNTRY_NAME, BANK_ACCOUNT_TYPE, SWIFT_CODE, IBAN, BANK_ACCOUNT_NUMBER, LOAD_TS, UPDATE_TS);

SELECT '✅ STEP 2 COMPLETE: Master data tables created and populated' AS status;

-- ═══════════════════════════════════════════════════════════════════════════════
-- STEP 3: CREATE TRANSACTIONAL DATA TABLES
-- ═══════════════════════════════════════════════════════════════════════════════

-- ───────────────────────────────────────────────────────────────────────────────
-- FACT_SALES_ORDERS - Sales Orders (Multi-Source)
-- ───────────────────────────────────────────────────────────────────────────────
CREATE OR REPLACE TABLE CORP_TRAN.FACT_SALES_ORDERS (
    SOURCE_SYSTEM VARCHAR(20),
    COMPANY_CODE VARCHAR(10),
    ORDER_ID VARCHAR(50),
    ORDER_LINE NUMBER(5,0),
    CUSTOMER_ID VARCHAR(50),
    ORDER_NUMBER VARCHAR(50),
    ORDER_DATE DATE,
    ORDER_TYPE VARCHAR(10),
    ORDER_STATUS VARCHAR(20),
    ORDER_QUANTITY NUMBER(18,3),
    ORDER_AMOUNT_LCL NUMBER(18,2),
    ORDER_AMOUNT_USD NUMBER(18,2),
    CURRENCY_CODE VARCHAR(5),
    SALES_ORG VARCHAR(10),
    SALES_OFFICE VARCHAR(10),
    PROFIT_CENTER VARCHAR(20),
    DISTRIBUTION_CHANNEL VARCHAR(10),
    DIVISION VARCHAR(10),
    MATERIAL_NUMBER VARCHAR(50),
    MATERIAL_DESCRIPTION VARCHAR(255),
    PRODUCT_HIERARCHY VARCHAR(50),
    CREATED_BY VARCHAR(50),
    CREATED_DATE TIMESTAMP_NTZ,
    CHANGED_BY VARCHAR(50),
    CHANGED_DATE TIMESTAMP_NTZ
) COMMENT = 'Sales orders from multiple ERP systems';

-- Generate orders across last 15 days for pattern testing
INSERT INTO CORP_TRAN.FACT_SALES_ORDERS
SELECT * FROM VALUES
    -- BRP900 Orders (North America) - Days 0-14
    ('BRP900', 'US01', 'ORD-BRP-00001', 10, 'CUST-BRP-001', 'SO-2024-00001', DATEADD('day', -14, CURRENT_DATE()), 'ZOR', 'COMPLETED', 100, 50000.00, 50000.00, 'USD', 'S001', 'OFF01', 'PC001', 'DC01', 'DIV01', 'MAT001', 'Industrial Sensor', 'PROD-01', 'USER001', DATEADD('day', -14, CURRENT_TIMESTAMP()), NULL, NULL),
    ('BRP900', 'US01', 'ORD-BRP-00002', 10, 'CUST-BRP-002', 'SO-2024-00002', DATEADD('day', -13, CURRENT_DATE()), 'ZOR', 'COMPLETED', 150, 75000.00, 75000.00, 'USD', 'S001', 'OFF01', 'PC002', 'DC01', 'DIV01', 'MAT002', 'Control Panel', 'PROD-01', 'USER002', DATEADD('day', -13, CURRENT_TIMESTAMP()), NULL, NULL),
    ('BRP900', 'US01', 'ORD-BRP-00003', 10, 'CUST-BRP-003', 'SO-2024-00003', DATEADD('day', -12, CURRENT_DATE()), 'ZOR', 'SHIPPED', 200, 100000.00, 100000.00, 'USD', 'S001', 'OFF02', 'PC001', 'DC01', 'DIV02', 'MAT003', 'Safety System', 'PROD-02', 'USER001', DATEADD('day', -12, CURRENT_TIMESTAMP()), NULL, NULL),
    ('BRP900', 'CA01', 'ORD-BRP-00004', 10, 'CUST-BRP-003', 'SO-2024-00004', DATEADD('day', -10, CURRENT_DATE()), 'ZOR', 'SHIPPED', 120, 60000.00, 60000.00, 'USD', 'S001', 'OFF02', 'PC003', 'DC02', 'DIV01', 'MAT004', 'Analytics Platform', 'PROD-03', 'USER003', DATEADD('day', -10, CURRENT_TIMESTAMP()), NULL, NULL),
    ('BRP900', 'US01', 'ORD-BRP-00005', 10, 'CUST-BRP-004', 'SO-2024-00005', DATEADD('day', -8, CURRENT_DATE()), 'ZOR', 'OPEN', 80, 40000.00, 40000.00, 'USD', 'S001', 'OFF01', 'PC001', 'DC01', 'DIV01', 'MAT005', 'Fire Detection', 'PROD-01', 'USER001', DATEADD('day', -8, CURRENT_TIMESTAMP()), NULL, NULL),
    ('BRP900', 'US01', 'ORD-BRP-00006', 10, 'CUST-BRP-001', 'SO-2024-00006', DATEADD('day', -5, CURRENT_DATE()), 'ZOR', 'COMPLETED', 90, 45000.00, 45000.00, 'USD', 'S001', 'OFF01', 'PC002', 'DC01', 'DIV02', 'MAT001', 'Industrial Sensor', 'PROD-01', 'USER002', DATEADD('day', -5, CURRENT_TIMESTAMP()), NULL, NULL),
    ('BRP900', 'US01', 'ORD-BRP-00007', 10, 'CUST-BRP-002', 'SO-2024-00007', DATEADD('day', -3, CURRENT_DATE()), 'ZOR', 'SHIPPED', 110, 55000.00, 55000.00, 'USD', 'S001', 'OFF01', 'PC001', 'DC01', 'DIV01', 'MAT002', 'Control Panel', 'PROD-01', 'USER001', DATEADD('day', -3, CURRENT_TIMESTAMP()), NULL, NULL),
    ('BRP900', 'US01', 'ORD-BRP-00008', 10, 'CUST-BRP-001', 'SO-2024-00008', DATEADD('day', -1, CURRENT_DATE()), 'ZOR', 'OPEN', 70, 35000.00, 35000.00, 'USD', 'S001', 'OFF02', 'PC003', 'DC02', 'DIV01', 'MAT003', 'Safety System', 'PROD-02', 'USER003', DATEADD('day', -1, CURRENT_TIMESTAMP()), NULL, NULL),
    
    -- CIP900 Orders (Europe) - Days 0-14
    ('CIP900', 'DE01', 'ORD-CIP-00101', 10, 'CUST-CIP-001', 'SO-2024-00101', DATEADD('day', -14, CURRENT_DATE()), 'ZOR', 'COMPLETED', 120, 96000.00, 105600.00, 'EUR', 'S002', 'OFF11', 'PC011', 'DC11', 'DIV11', 'MAT011', 'Building Controller', 'PROD-11', 'USER011', DATEADD('day', -14, CURRENT_TIMESTAMP()), NULL, NULL),
    ('CIP900', 'FR01', 'ORD-CIP-00102', 10, 'CUST-CIP-002', 'SO-2024-00102', DATEADD('day', -12, CURRENT_DATE()), 'ZOR', 'COMPLETED', 90, 72000.00, 79200.00, 'EUR', 'S002', 'OFF12', 'PC012', 'DC11', 'DIV11', 'MAT012', 'HVAC System', 'PROD-11', 'USER012', DATEADD('day', -12, CURRENT_TIMESTAMP()), NULL, NULL),
    ('CIP900', 'DE01', 'ORD-CIP-00103', 10, 'CUST-CIP-003', 'SO-2024-00103', DATEADD('day', -10, CURRENT_DATE()), 'ZOR', 'SHIPPED', 110, 88000.00, 96800.00, 'EUR', 'S002', 'OFF11', 'PC011', 'DC11', 'DIV12', 'MAT013', 'Access Control', 'PROD-12', 'USER011', DATEADD('day', -10, CURRENT_TIMESTAMP()), NULL, NULL),
    ('CIP900', 'IT01', 'ORD-CIP-00104', 10, 'CUST-CIP-004', 'SO-2024-00104', DATEADD('day', -7, CURRENT_DATE()), 'ZOR', 'SHIPPED', 140, 112000.00, 123200.00, 'EUR', 'S002', 'OFF13', 'PC013', 'DC12', 'DIV11', 'MAT014', 'Energy Management', 'PROD-11', 'USER013', DATEADD('day', -7, CURRENT_TIMESTAMP()), NULL, NULL),
    ('CIP900', 'DE01', 'ORD-CIP-00105', 10, 'CUST-CIP-001', 'SO-2024-00105', DATEADD('day', -4, CURRENT_DATE()), 'ZOR', 'OPEN', 95, 76000.00, 83600.00, 'EUR', 'S002', 'OFF11', 'PC011', 'DC11', 'DIV11', 'MAT011', 'Building Controller', 'PROD-11', 'USER011', DATEADD('day', -4, CURRENT_TIMESTAMP()), NULL, NULL),
    ('CIP900', 'FR01', 'ORD-CIP-00106', 10, 'CUST-CIP-002', 'SO-2024-00106', DATEADD('day', -2, CURRENT_DATE()), 'ZOR', 'COMPLETED', 85, 68000.00, 74800.00, 'EUR', 'S002', 'OFF12', 'PC012', 'DC11', 'DIV12', 'MAT012', 'HVAC System', 'PROD-11', 'USER012', DATEADD('day', -2, CURRENT_TIMESTAMP()), NULL, NULL),
    
    -- EEP300 Orders (Asia Pacific) - Days 0-14
    ('EEP300', 'JP01', 'ORD-EEP-00201', 10, 'CUST-EEP-001', 'SO-2024-00201', DATEADD('day', -14, CURRENT_DATE()), 'ZOR', 'COMPLETED', 85, 68000.00, 50660.00, 'JPY', 'S003', 'OFF21', 'PC021', 'DC21', 'DIV21', 'MAT021', 'Smart Thermostat', 'PROD-21', 'USER021', DATEADD('day', -14, CURRENT_TIMESTAMP()), NULL, NULL),
    ('EEP300', 'SG01', 'ORD-EEP-00202', 10, 'CUST-EEP-002', 'SO-2024-00202', DATEADD('day', -11, CURRENT_DATE()), 'ZOR', 'COMPLETED', 95, 76000.00, 56620.00, 'SGD', 'S003', 'OFF22', 'PC022', 'DC21', 'DIV21', 'MAT022', 'Gas Detector', 'PROD-21', 'USER022', DATEADD('day', -11, CURRENT_TIMESTAMP()), NULL, NULL),
    ('EEP300', 'AU01', 'ORD-EEP-00203', 10, 'CUST-EEP-003', 'SO-2024-00203', DATEADD('day', -9, CURRENT_DATE()), 'ZOR', 'SHIPPED', 105, 84000.00, 62580.00, 'AUD', 'S003', 'OFF23', 'PC023', 'DC22', 'DIV22', 'MAT023', 'Pressure Sensor', 'PROD-22', 'USER023', DATEADD('day', -9, CURRENT_TIMESTAMP()), NULL, NULL),
    ('EEP300', 'KR01', 'ORD-EEP-00204', 10, 'CUST-EEP-004', 'SO-2024-00204', DATEADD('day', -6, CURRENT_DATE()), 'ZOR', 'SHIPPED', 75, 60000.00, 44700.00, 'KRW', 'S003', 'OFF24', 'PC021', 'DC21', 'DIV21', 'MAT024', 'Temperature Control', 'PROD-21', 'USER021', DATEADD('day', -6, CURRENT_TIMESTAMP()), NULL, NULL),
    ('EEP300', 'SG01', 'ORD-EEP-00205', 10, 'CUST-EEP-002', 'SO-2024-00205', DATEADD('day', -3, CURRENT_DATE()), 'ZOR', 'OPEN', 100, 80000.00, 59600.00, 'SGD', 'S003', 'OFF22', 'PC022', 'DC21', 'DIV22', 'MAT022', 'Gas Detector', 'PROD-21', 'USER022', DATEADD('day', -3, CURRENT_TIMESTAMP()), NULL, NULL)
AS t(SOURCE_SYSTEM, COMPANY_CODE, ORDER_ID, ORDER_LINE, CUSTOMER_ID, ORDER_NUMBER, ORDER_DATE, ORDER_TYPE, ORDER_STATUS, ORDER_QUANTITY, ORDER_AMOUNT_LCL, ORDER_AMOUNT_USD, CURRENCY_CODE, SALES_ORG, SALES_OFFICE, PROFIT_CENTER, DISTRIBUTION_CHANNEL, DIVISION, MATERIAL_NUMBER, MATERIAL_DESCRIPTION, PRODUCT_HIERARCHY, CREATED_BY, CREATED_DATE, CHANGED_BY, CHANGED_DATE);

-- ───────────────────────────────────────────────────────────────────────────────
-- FACT_INVOICES - Customer Invoices
-- ───────────────────────────────────────────────────────────────────────────────
CREATE OR REPLACE TABLE CORP_TRAN.FACT_INVOICES (
    SOURCE_SYSTEM VARCHAR(20),
    COMPANY_CODE VARCHAR(10),
    INVOICE_ID VARCHAR(50),
    INVOICE_LINE NUMBER(5,0),
    ORDER_ID VARCHAR(50),
    ORDER_LINE NUMBER(5,0),
    INVOICE_NUMBER VARCHAR(50),
    INVOICE_DATE DATE,
    POSTING_DATE DATE,
    INVOICE_TYPE VARCHAR(10),
    INVOICE_STATUS VARCHAR(20),
    BILLING_DOCUMENT VARCHAR(50),
    INVOICE_QUANTITY NUMBER(18,3),
    INVOICE_AMOUNT_LCL NUMBER(18,2),
    INVOICE_AMOUNT_USD NUMBER(18,2),
    TAX_AMOUNT_LCL NUMBER(18,2),
    FREIGHT_AMOUNT_LCL NUMBER(18,2),
    CURRENCY_CODE VARCHAR(5),
    PAYMENT_TERMS_CODE VARCHAR(10),
    GL_ACCOUNT VARCHAR(20),
    COST_CENTER VARCHAR(20),
    PROFIT_CENTER VARCHAR(20),
    SALES_ORG VARCHAR(10),
    CREATED_BY VARCHAR(50),
    CREATED_DATE TIMESTAMP_NTZ
) COMMENT = 'Customer invoices';

-- Create invoices for shipped/completed orders
INSERT INTO CORP_TRAN.FACT_INVOICES
SELECT * FROM VALUES
    -- BRP900 Invoices
    ('BRP900', 'US01', 'INV-BRP-00001', 10, 'ORD-BRP-00001', 10, 'IV-2024-00001', DATEADD('day', -13, CURRENT_DATE()), DATEADD('day', -13, CURRENT_DATE()), 'F2', 'POSTED', 'BL-00001', 100, 50000.00, 50000.00, 4000.00, 500.00, 'USD', 'NET30', '4000000', 'CC001', 'PC001', 'S001', 'SYS001', DATEADD('day', -13, CURRENT_TIMESTAMP())),
    ('BRP900', 'US01', 'INV-BRP-00002', 10, 'ORD-BRP-00002', 10, 'IV-2024-00002', DATEADD('day', -12, CURRENT_DATE()), DATEADD('day', -12, CURRENT_DATE()), 'F2', 'POSTED', 'BL-00002', 150, 75000.00, 75000.00, 6000.00, 750.00, 'USD', 'NET45', '4000000', 'CC002', 'PC002', 'S001', 'SYS001', DATEADD('day', -12, CURRENT_TIMESTAMP())),
    ('BRP900', 'US01', 'INV-BRP-00003', 10, 'ORD-BRP-00003', 10, 'IV-2024-00003', DATEADD('day', -11, CURRENT_DATE()), DATEADD('day', -11, CURRENT_DATE()), 'F2', 'OPEN', 'BL-00003', 200, 100000.00, 100000.00, 8000.00, 1000.00, 'USD', 'NET30', '4000000', 'CC001', 'PC001', 'S001', 'SYS001', DATEADD('day', -11, CURRENT_TIMESTAMP())),
    ('BRP900', 'US01', 'INV-BRP-00006', 10, 'ORD-BRP-00006', 10, 'IV-2024-00006', DATEADD('day', -4, CURRENT_DATE()), DATEADD('day', -4, CURRENT_DATE()), 'F2', 'POSTED', 'BL-00006', 90, 45000.00, 45000.00, 3600.00, 450.00, 'USD', 'NET30', '4000000', 'CC002', 'PC002', 'S001', 'SYS001', DATEADD('day', -4, CURRENT_TIMESTAMP())),
    
    -- CIP900 Invoices
    ('CIP900', 'DE01', 'INV-CIP-00101', 10, 'ORD-CIP-00101', 10, 'IV-2024-00101', DATEADD('day', -13, CURRENT_DATE()), DATEADD('day', -13, CURRENT_DATE()), 'F2', 'POSTED', 'BL-00101', 120, 96000.00, 105600.00, 18240.00, 1920.00, 'EUR', 'NET60', '4000100', 'CC011', 'PC011', 'S002', 'SYS011', DATEADD('day', -13, CURRENT_TIMESTAMP())),
    ('CIP900', 'FR01', 'INV-CIP-00102', 10, 'ORD-CIP-00102', 10, 'IV-2024-00102', DATEADD('day', -11, CURRENT_DATE()), DATEADD('day', -11, CURRENT_DATE()), 'F2', 'POSTED', 'BL-00102', 90, 72000.00, 79200.00, 13680.00, 1440.00, 'EUR', 'NET30', '4000100', 'CC012', 'PC012', 'S002', 'SYS012', DATEADD('day', -11, CURRENT_TIMESTAMP())),
    ('CIP900', 'FR01', 'INV-CIP-00106', 10, 'ORD-CIP-00106', 10, 'IV-2024-00106', DATEADD('day', -1, CURRENT_DATE()), DATEADD('day', -1, CURRENT_DATE()), 'F2', 'OPEN', 'BL-00106', 85, 68000.00, 74800.00, 12920.00, 1360.00, 'EUR', 'NET30', '4000200', 'CC012', 'PC012', 'S002', 'SYS012', DATEADD('day', -1, CURRENT_TIMESTAMP())),
    
    -- EEP300 Invoices
    ('EEP300', 'JP01', 'INV-EEP-00201', 10, 'ORD-EEP-00201', 10, 'IV-2024-00201', DATEADD('day', -13, CURRENT_DATE()), DATEADD('day', -13, CURRENT_DATE()), 'F2', 'POSTED', 'BL-00201', 85, 68000.00, 50660.00, 4760.00, 1360.00, 'JPY', 'NET45', '4000300', 'CC021', 'PC021', 'S003', 'SYS021', DATEADD('day', -13, CURRENT_TIMESTAMP())),
    ('EEP300', 'SG01', 'INV-EEP-00202', 10, 'ORD-EEP-00202', 10, 'IV-2024-00202', DATEADD('day', -10, CURRENT_DATE()), DATEADD('day', -10, CURRENT_DATE()), 'F2', 'POSTED', 'BL-00202', 95, 76000.00, 56620.00, 5320.00, 1520.00, 'SGD', 'NET30', '4000300', 'CC022', 'PC022', 'S003', 'SYS022', DATEADD('day', -10, CURRENT_TIMESTAMP()))
AS t(SOURCE_SYSTEM, COMPANY_CODE, INVOICE_ID, INVOICE_LINE, ORDER_ID, ORDER_LINE, INVOICE_NUMBER, INVOICE_DATE, POSTING_DATE, INVOICE_TYPE, INVOICE_STATUS, BILLING_DOCUMENT, INVOICE_QUANTITY, INVOICE_AMOUNT_LCL, INVOICE_AMOUNT_USD, TAX_AMOUNT_LCL, FREIGHT_AMOUNT_LCL, CURRENCY_CODE, PAYMENT_TERMS_CODE, GL_ACCOUNT, COST_CENTER, PROFIT_CENTER, SALES_ORG, CREATED_BY, CREATED_DATE);

-- ───────────────────────────────────────────────────────────────────────────────
-- FACT_PAYMENTS - Payment Transactions
-- ───────────────────────────────────────────────────────────────────────────────
CREATE OR REPLACE TABLE CORP_TRAN.FACT_PAYMENTS (
    SOURCE_SYSTEM VARCHAR(20),
    COMPANY_CODE VARCHAR(10),
    PAYMENT_ID VARCHAR(50),
    INVOICE_ID VARCHAR(50),
    INVOICE_LINE NUMBER(5,0),
    PAYMENT_REFERENCE VARCHAR(50),
    PAYMENT_DATE DATE,
    CLEARING_DATE DATE,
    VALUE_DATE DATE,
    PAYMENT_METHOD_CODE VARCHAR(10),
    PAYMENT_TYPE VARCHAR(20),
    PAYMENT_AMOUNT_LCL NUMBER(18,2),
    PAYMENT_AMOUNT_USD NUMBER(18,2),
    DISCOUNT_AMOUNT_LCL NUMBER(18,2),
    CURRENCY_CODE VARCHAR(5),
    BANK_ACCOUNT_ID VARCHAR(20),
    PAYMENT_STATUS VARCHAR(20),
    CLEARED_FLAG BOOLEAN,
    RECONCILED_FLAG BOOLEAN,
    REVERSED_FLAG BOOLEAN,
    GL_ACCOUNT VARCHAR(20),
    PROFIT_CENTER VARCHAR(20),
    COST_CENTER VARCHAR(20),
    CREATED_BY VARCHAR(50),
    CREATED_DATE TIMESTAMP_NTZ
) COMMENT = 'Customer payments and cash receipts';

-- Create payments for older invoices
INSERT INTO CORP_TRAN.FACT_PAYMENTS
SELECT * FROM VALUES
    -- BRP900 Payments
    ('BRP900', 'US01', 'PAY-BRP-00001', 'INV-BRP-00001', 10, 'CHK-12345', DATEADD('day', -8, CURRENT_DATE()), DATEADD('day', -8, CURRENT_DATE()), DATEADD('day', -8, CURRENT_DATE()), 'CHK', 'CUSTOMER_PMT', 50000.00, 50000.00, 0.00, 'USD', 'BNK-BRP-001', 'CLEARED', TRUE, TRUE, FALSE, '1100000', 'PC001', 'CC001', 'SYS001', DATEADD('day', -8, CURRENT_TIMESTAMP())),
    ('BRP900', 'US01', 'PAY-BRP-00002', 'INV-BRP-00002', 10, 'WIRE-67890', DATEADD('day', -7, CURRENT_DATE()), DATEADD('day', -7, CURRENT_DATE()), DATEADD('day', -7, CURRENT_DATE()), 'WIRE', 'CUSTOMER_PMT', 75000.00, 75000.00, 750.00, 'USD', 'BNK-BRP-001', 'CLEARED', TRUE, TRUE, FALSE, '1100000', 'PC002', 'CC002', 'SYS001', DATEADD('day', -7, CURRENT_TIMESTAMP())),
    
    -- CIP900 Payments
    ('CIP900', 'DE01', 'PAY-CIP-00101', 'INV-CIP-00101', 10, 'SEPA-1001', DATEADD('day', -6, CURRENT_DATE()), DATEADD('day', -6, CURRENT_DATE()), DATEADD('day', -6, CURRENT_DATE()), 'SEPA', 'CUSTOMER_PMT', 96000.00, 105600.00, 0.00, 'EUR', 'BNK-CIP-001', 'CLEARED', TRUE, TRUE, FALSE, '1100100', 'PC011', 'CC011', 'SYS011', DATEADD('day', -6, CURRENT_TIMESTAMP())),
    ('CIP900', 'FR01', 'PAY-CIP-00102', 'INV-CIP-00102', 10, 'SEPA-1002', DATEADD('day', -5, CURRENT_DATE()), DATEADD('day', -5, CURRENT_DATE()), DATEADD('day', -5, CURRENT_DATE()), 'SEPA', 'CUSTOMER_PMT', 72000.00, 79200.00, 720.00, 'EUR', 'BNK-CIP-001', 'CLEARED', TRUE, TRUE, FALSE, '1100100', 'PC012', 'CC012', 'SYS012', DATEADD('day', -5, CURRENT_TIMESTAMP())),
    
    -- EEP300 Payments
    ('EEP300', 'JP01', 'PAY-EEP-00201', 'INV-EEP-00201', 10, 'GIRO-2001', DATEADD('day', -4, CURRENT_DATE()), DATEADD('day', -4, CURRENT_DATE()), DATEADD('day', -4, CURRENT_DATE()), 'GIRO', 'CUSTOMER_PMT', 68000.00, 50660.00, 0.00, 'JPY', 'BNK-EEP-001', 'CLEARED', TRUE, TRUE, FALSE, '1100200', 'PC021', 'CC021', 'SYS021', DATEADD('day', -4, CURRENT_TIMESTAMP()))
AS t(SOURCE_SYSTEM, COMPANY_CODE, PAYMENT_ID, INVOICE_ID, INVOICE_LINE, PAYMENT_REFERENCE, PAYMENT_DATE, CLEARING_DATE, VALUE_DATE, PAYMENT_METHOD_CODE, PAYMENT_TYPE, PAYMENT_AMOUNT_LCL, PAYMENT_AMOUNT_USD, DISCOUNT_AMOUNT_LCL, CURRENCY_CODE, BANK_ACCOUNT_ID, PAYMENT_STATUS, CLEARED_FLAG, RECONCILED_FLAG, REVERSED_FLAG, GL_ACCOUNT, PROFIT_CENTER, COST_CENTER, CREATED_BY, CREATED_DATE);

SELECT '✅ STEP 3 COMPLETE: Transactional data tables created and populated' AS status;

-- ═══════════════════════════════════════════════════════════════════════════════
-- STEP 4: GRANT PERMISSIONS TO DBT ROLES
-- ═══════════════════════════════════════════════════════════════════════════════

GRANT USAGE ON SCHEMA EDW.CORP_TRAN TO ROLE DBT_O2C_DEVELOPER;
GRANT USAGE ON SCHEMA EDW.CORP_MASTER TO ROLE DBT_O2C_DEVELOPER;
GRANT SELECT ON ALL TABLES IN SCHEMA EDW.CORP_TRAN TO ROLE DBT_O2C_DEVELOPER;
GRANT SELECT ON ALL TABLES IN SCHEMA EDW.CORP_MASTER TO ROLE DBT_O2C_DEVELOPER;
GRANT SELECT ON FUTURE TABLES IN SCHEMA EDW.CORP_TRAN TO ROLE DBT_O2C_DEVELOPER;
GRANT SELECT ON FUTURE TABLES IN SCHEMA EDW.CORP_MASTER TO ROLE DBT_O2C_DEVELOPER;

SELECT '✅ STEP 4 COMPLETE: Permissions granted to DBT_O2C_DEVELOPER' AS status;

-- ═══════════════════════════════════════════════════════════════════════════════
-- STEP 5: VERIFICATION & DATA SUMMARY
-- ═══════════════════════════════════════════════════════════════════════════════

SELECT '═══════════════════════════════════════════════════════════════' AS separator;
SELECT '✅ O2C ENHANCED SAMPLE DATA SETUP COMPLETE!' AS final_status;
SELECT '═══════════════════════════════════════════════════════════════' AS separator;

-- Summary: Row counts
SELECT 'MASTER DATA' AS category, 'DIM_CUSTOMER' AS table_name, COUNT(*) AS row_count FROM CORP_MASTER.DIM_CUSTOMER
UNION ALL SELECT 'MASTER DATA', 'DIM_PAYMENT_TERMS', COUNT(*) FROM CORP_MASTER.DIM_PAYMENT_TERMS
UNION ALL SELECT 'MASTER DATA', 'DIM_BANK_ACCOUNT', COUNT(*) FROM CORP_MASTER.DIM_BANK_ACCOUNT
UNION ALL SELECT 'TRANSACTIONAL', 'FACT_SALES_ORDERS', COUNT(*) FROM CORP_TRAN.FACT_SALES_ORDERS
UNION ALL SELECT 'TRANSACTIONAL', 'FACT_INVOICES', COUNT(*) FROM CORP_TRAN.FACT_INVOICES
UNION ALL SELECT 'TRANSACTIONAL', 'FACT_PAYMENTS', COUNT(*) FROM CORP_TRAN.FACT_PAYMENTS
ORDER BY category, table_name;

-- Summary: Orders by source system
SELECT '--- ORDERS BY SOURCE SYSTEM ---' AS report;
SELECT 
    SOURCE_SYSTEM,
    COUNT(*) AS order_count,
    SUM(ORDER_AMOUNT_USD) AS total_usd,
    MIN(ORDER_DATE) AS earliest_order,
    MAX(ORDER_DATE) AS latest_order
FROM CORP_TRAN.FACT_SALES_ORDERS
GROUP BY SOURCE_SYSTEM
ORDER BY SOURCE_SYSTEM;

-- Summary: Orders by date (for delete+insert testing)
SELECT '--- ORDERS BY DATE (Last 15 Days) ---' AS report;
SELECT 
    ORDER_DATE,
    COUNT(*) AS order_count,
    COUNT(DISTINCT SOURCE_SYSTEM) AS source_systems
FROM CORP_TRAN.FACT_SALES_ORDERS
WHERE ORDER_DATE >= DATEADD('day', -15, CURRENT_DATE())
GROUP BY ORDER_DATE
ORDER BY ORDER_DATE DESC;

SELECT '✅ Ready for dbt build!' AS status;


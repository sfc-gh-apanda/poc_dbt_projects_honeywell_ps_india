version: 2

models:
  # ═══════════════════════════════════════════════════════════════════════════════
  # DIMENSION LAYER - Customer Dimension (SCD-2 with Soft Delete)
  # ═══════════════════════════════════════════════════════════════════════════════
  # Pattern: SCD-2 built on dbt snapshot
  # Features:
  #   - Full history preservation
  #   - Soft delete (is_deleted, deleted_at)
  #   - Industry standard columns (is_current, is_active, record_status)
  #   - Point-in-time query support
  #
  # Prerequisites:
  #   Run snapshot first: dbt snapshot --select snap_customer
  # ═══════════════════════════════════════════════════════════════════════════════

  - name: dim_o2c_customer
    description: |
      **Customer Dimension (SCD-2 with Soft Delete)**
      
      **Data Load Pattern:** SCD-2 based on dbt snapshot
      
      Tracks all historical changes to customer data. When a customer is 
      deleted from source, the record is soft-deleted (is_deleted=TRUE),
      never physically removed.
      
      **Key Columns:**
      | Column | Description |
      |--------|-------------|
      | is_current | TRUE = Latest version of this customer |
      | is_active | TRUE = Active in current business operations |
      | is_deleted | TRUE = Removed from source (soft delete) |
      | record_status | ACTIVE, INACTIVE, DELETED, HISTORICAL |
      
      **Query Patterns:**
      ```sql
      -- Current active customers only
      SELECT * FROM dim_o2c_customer WHERE is_current AND is_active;
      
      -- All current customers (including deleted)
      SELECT * FROM dim_o2c_customer WHERE is_current;
      
      -- Point-in-time: Customer as of specific date
      SELECT * FROM dim_o2c_customer 
      WHERE '2024-06-15' BETWEEN dbt_valid_from 
        AND COALESCE(dbt_valid_to, '9999-12-31');
      
      -- Audit: Recently deleted customers
      SELECT * FROM dim_o2c_customer 
      WHERE is_deleted ORDER BY deleted_at DESC;
      ```
      
      **Prerequisites:** Run snapshot first
      ```bash
      dbt snapshot --select snap_customer
      dbt run --select dim_o2c_customer
      ```
    
    access: public
    
    config:
      tags: ['dimension', 'scd2', 'soft_delete', 'pattern_example']
      # Note: contract removed as SCD-2 columns have dynamic types
    
    columns:
      # ═══════════════════════════════════════════════════════════════
      # KEYS
      # ═══════════════════════════════════════════════════════════════
      - name: customer_key
        description: "Surrogate key (customer_id|source|valid_from) - unique per version"
        tests:
          - unique
          - not_null
      
      - name: customer_business_key
        description: "Business key (customer_id|source) - use with is_current=TRUE for joins"
        tests:
          - not_null
      
      - name: source_system
        description: "Source ERP system (BRP, CIP, EEP, etc.)"
        tests:
          - not_null
      
      - name: customer_id
        description: "Customer ID (natural key from source)"
        tests:
          - not_null
      
      # ═══════════════════════════════════════════════════════════════
      # BUSINESS ATTRIBUTES
      # ═══════════════════════════════════════════════════════════════
      - name: customer_name
        description: "Customer legal name"
      
      - name: customer_type
        description: "Customer type (E=External, I=Internal)"
      
      - name: customer_country
        description: "Customer country code (ISO)"
      
      - name: customer_country_name
        description: "Customer country full name"
      
      - name: customer_classification
        description: "Customer classification code"
      
      - name: customer_account_group
        description: "Customer account group"
      
      # ═══════════════════════════════════════════════════════════════
      # MDM ATTRIBUTES
      # ═══════════════════════════════════════════════════════════════
      - name: duns_number
        description: "D&B DUNS number"
      
      - name: global_ultimate_duns
        description: "MDM Global Ultimate DUNS number"
      
      - name: global_ultimate_name
        description: "MDM Global Ultimate company name"
      
      - name: full_name
        description: "MDM Full customer name"
      
      # ═══════════════════════════════════════════════════════════════
      # DERIVED FLAGS
      # ═══════════════════════════════════════════════════════════════
      - name: is_internal
        description: "TRUE if internal customer (customer_type='I')"
      
      # ═══════════════════════════════════════════════════════════════
      # SCD-2 VALIDITY COLUMNS (from dbt snapshot)
      # ═══════════════════════════════════════════════════════════════
      - name: dbt_valid_from
        description: "SCD-2: When this version became effective"
        tests:
          - not_null
      
      - name: dbt_valid_to
        description: "SCD-2: When this version ended (NULL = current version)"
      
      - name: dbt_scd_id
        description: "dbt snapshot unique version ID"
        tests:
          - unique
          - not_null
      
      - name: dbt_snapshot_updated_at
        description: "When snapshot last processed this record"
      
      # ═══════════════════════════════════════════════════════════════
      # SOFT DELETE & STATUS COLUMNS (Industry Standard)
      # ═══════════════════════════════════════════════════════════════
      - name: is_current
        description: |
          **Is this the latest version of this customer?**
          - TRUE: This is the most recent version
          - FALSE: This is a historical version (superseded)
          
          Use for joins: WHERE is_current = TRUE
        tests:
          - not_null
      
      - name: is_active
        description: |
          **Is this customer active in business operations?**
          - TRUE: Current version AND source_is_active AND not deleted
          - FALSE: Historical, inactive in source, or deleted
          
          Use for active customer queries: WHERE is_current AND is_active
        tests:
          - not_null
      
      - name: is_deleted
        description: |
          **Was this customer soft-deleted (removed from source)?**
          - TRUE: Record was in source, now gone (soft delete)
          - FALSE: Record still exists in source
          
          Only the final version before deletion has is_deleted=TRUE
        tests:
          - not_null
      
      - name: deleted_at
        description: |
          **When was this customer soft-deleted?**
          - Timestamp when record disappeared from source
          - NULL if not deleted
      
      - name: record_status
        description: |
          **Comprehensive lifecycle status:**
          - ACTIVE: Current version, active in source
          - INACTIVE: Current version, marked inactive in source
          - DELETED: Removed from source (soft delete)
          - HISTORICAL: Old version, superseded by newer version
        tests:
          - not_null
          - accepted_values:
              values: ['ACTIVE', 'INACTIVE', 'DELETED', 'HISTORICAL']
      
      # ═══════════════════════════════════════════════════════════════
      # SOURCE TRACKING
      # ═══════════════════════════════════════════════════════════════
      - name: source_load_ts
        description: "Source system load timestamp"
      
      - name: source_update_ts
        description: "Source system update timestamp"
      
      # ═══════════════════════════════════════════════════════════════
      # CHANGE DETECTION
      # ═══════════════════════════════════════════════════════════════
      - name: dbt_row_hash
        description: "MD5 hash of business columns for downstream change detection"
        tests:
          - not_null
      
      # ═══════════════════════════════════════════════════════════════
      # AUDIT COLUMNS (Standard 7-column set)
      # ═══════════════════════════════════════════════════════════════
      - name: dbt_run_id
        description: "dbt invocation ID"
        tests:
          - not_null
      
      - name: dbt_batch_id
        description: "Batch ID (unique per model per run)"
        tests:
          - not_null
      
      - name: dbt_loaded_at
        description: "When this dimension table was refreshed"
        tests:
          - not_null
      
      - name: dbt_created_at
        description: "Record creation timestamp"
        tests:
          - not_null
      
      - name: dbt_updated_at
        description: "Record update timestamp"
        tests:
          - not_null
      
      - name: dbt_source_model
        description: "Model name that created this record"
        tests:
          - not_null
      
      - name: dbt_environment
        description: "Target environment (dev/prod)"
        tests:
          - not_null

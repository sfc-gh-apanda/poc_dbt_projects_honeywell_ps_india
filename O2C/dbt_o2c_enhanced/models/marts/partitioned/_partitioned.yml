version: 2

models:
  # ═══════════════════════════════════════════════════════════════════════════════
  # PARTITIONED LAYER - Date/Source Partitioned Facts
  # ═══════════════════════════════════════════════════════════════════════════════
  # Patterns: DELETE+INSERT and PRE-HOOK DELETE
  # Audit: Full 7-column audit set (dbt_created_at = dbt_updated_at for inserts)
  # Contract: ENFORCED - Column names and types must match specification
  # ═══════════════════════════════════════════════════════════════════════════════

  - name: fact_o2c_daily
    description: |
      **Daily O2C Fact Table (Date Partitioned)**
      
      **Data Load Pattern:** DELETE + INSERT (incremental_strategy='delete+insert')
      
      Reloads data for a configurable date window (default: last 3 days).
      Ideal for handling late-arriving data and corrections.
      
      **Contract:** ENFORCED - Ensures column names and types match target table
      **Schema Change:** FAIL - Prevents accidental column name mismatches
      
      **Configuration:**
      - var('reload_days'): Number of days to reload (default: 3)
      - Run with: `dbt run --select fact_o2c_daily --vars '{"reload_days": 7}'`
      
      **Audit Columns (7 uniform):**
      - dbt_run_id: dbt invocation ID
      - dbt_batch_id: Unique per model per run
      - dbt_loaded_at: Load timestamp
      - dbt_created_at: = dbt_updated_at (records are re-inserted, not updated)
      - dbt_updated_at: Same as created
      - dbt_source_model: Model name
      - dbt_environment: Target environment (dev/prod)
    
    access: public
    
    config:
      tags: ['partitioned', 'delete_insert', 'pattern_example']
      on_schema_change: 'fail'
      contract:
        enforced: true
    
    columns:
      # Partition Key
      - name: order_date
        description: "Order date (partition key)"
        data_type: date
        tests:
          - not_null
      
      # Keys
      - name: source_system
        description: "Source ERP system"
        data_type: varchar
        tests:
          - not_null
      
      - name: order_key
        description: "Order surrogate key"
        data_type: varchar
        tests:
          - not_null
      
      - name: invoice_key
        description: "Invoice surrogate key"
        data_type: varchar
      
      - name: payment_key
        description: "Payment surrogate key"
        data_type: varchar
      
      # Order Details
      - name: order_id
        description: "Order ID"
        data_type: varchar
      
      - name: order_line
        description: "Order line number"
        data_type: number
      
      - name: customer_id
        description: "Customer ID"
        data_type: varchar
      
      - name: customer_name
        description: "Customer name"
        data_type: varchar
      
      - name: order_amount
        description: "Order amount"
        data_type: number
      
      - name: order_currency
        description: "Order currency"
        data_type: varchar
      
      - name: order_status
        description: "Order status"
        data_type: varchar
      
      # Invoice Details
      - name: invoice_date
        description: "Invoice date"
        data_type: date
      
      - name: invoice_amount
        description: "Invoice amount"
        data_type: number
      
      - name: due_date
        description: "Payment due date"
        data_type: date
      
      # Payment Details
      - name: payment_date
        description: "Payment date"
        data_type: date
      
      - name: payment_amount
        description: "Payment amount"
        data_type: number
      
      # Status
      - name: invoice_status
        description: "INVOICED or NOT_INVOICED"
        data_type: varchar
        tests:
          - accepted_values:
              values: ['INVOICED', 'NOT_INVOICED']
      
      - name: payment_status
        description: "PAID or UNPAID"
        data_type: varchar
        tests:
          - accepted_values:
              values: ['PAID', 'UNPAID']
      
      # Audit Columns (7 uniform columns)
      - name: dbt_run_id
        description: "dbt invocation ID"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_batch_id
        description: "Batch ID (unique per model per run)"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_loaded_at
        description: "Load timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_created_at
        description: "Record creation timestamp (= dbt_updated_at for delete+insert)"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_updated_at
        description: "Record update timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_source_model
        description: "Model name that created this record"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_environment
        description: "Target environment (dev/prod)"
        data_type: varchar
        tests:
          - not_null

  - name: fact_o2c_by_source
    description: |
      **Source System Partitioned Fact Table**
      
      **Data Load Pattern:** PRE-HOOK DELETE + APPEND
      
      Allows selective reload of specific source systems.
      Pre-hook deletes target source, then appends fresh data.
      
      **Contract:** ENFORCED - Ensures column names and types match target table
      **Schema Change:** FAIL - Prevents accidental column name mismatches
      
      **Configuration:**
      - var('reload_source'): Source system to reload (default: 'ALL')
      - Run for specific source: `dbt run --select fact_o2c_by_source --vars '{"reload_source": "BRP"}'`
      
      **Audit Columns (7 uniform):**
      - dbt_run_id: dbt invocation ID
      - dbt_batch_id: Unique per model per run
      - dbt_loaded_at: Load timestamp
      - dbt_created_at: = dbt_updated_at (records are re-inserted)
      - dbt_updated_at: Same as created
      - dbt_source_model: Model name
      - dbt_environment: Target environment (dev/prod)
    
    access: public
    
    config:
      tags: ['partitioned', 'pre_hook_delete', 'source_reload', 'pattern_example']
      on_schema_change: 'fail'
      contract:
        enforced: true
    
    columns:
      # Source Partition Key
      - name: source_system
        description: "Source ERP system (partition key)"
        data_type: varchar
        tests:
          - not_null
      
      # Keys
      - name: order_key
        description: "Order surrogate key"
        data_type: varchar
        tests:
          - not_null
      
      - name: order_id
        description: "Order ID"
        data_type: varchar
        tests:
          - not_null
      
      # Order Details
      - name: order_date
        description: "Order date"
        data_type: date
      
      - name: customer_id
        description: "Customer ID"
        data_type: varchar
      
      - name: customer_name
        description: "Customer name"
        data_type: varchar
      
      - name: order_amount
        description: "Order amount"
        data_type: number
      
      - name: order_currency
        description: "Order currency"
        data_type: varchar
      
      - name: order_status
        description: "Order status"
        data_type: varchar
      
      # Audit Columns (7 uniform columns)
      - name: dbt_run_id
        description: "dbt invocation ID"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_batch_id
        description: "Batch ID (unique per model per run)"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_loaded_at
        description: "Load timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_created_at
        description: "Record creation timestamp (= dbt_updated_at for pre-hook delete)"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_updated_at
        description: "Record update timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_source_model
        description: "Model name that created this record"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_environment
        description: "Target environment (dev/prod)"
        data_type: varchar
        tests:
          - not_null

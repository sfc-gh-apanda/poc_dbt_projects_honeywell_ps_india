version: 2

models:
  # ═══════════════════════════════════════════════════════════════════════════════
  # STAGING LAYER - Views with Customer/Invoice/Payment Enrichment
  # ═══════════════════════════════════════════════════════════════════════════════
  # Pattern: VIEW (always current, no materialization)
  # Audit: Full 7-column audit set (uniform across all layers)
  # Contract: ENFORCED - Column names and types must match specification
  # ═══════════════════════════════════════════════════════════════════════════════

  - name: stg_enriched_orders
    description: |
      **Orders with Customer Enrichment**
      
      Joins FACT_SALES_ORDERS with DIM_CUSTOMER.
      
      **Pattern:** VIEW (always current)
      **Contract:** ENFORCED - Ensures column names and types match specification
      **Audit:** 7 columns (dbt_run_id, dbt_batch_id, dbt_loaded_at, dbt_created_at, dbt_updated_at, dbt_source_model, dbt_environment)
    access: protected
    config:
      tags: ['staging', 'orders']
      contract:
        enforced: true
    columns:
      # Business Keys
      - name: source_system
        description: "Source ERP system"
        data_type: varchar
        tests:
          - not_null
      
      - name: company_code
        description: "Company code"
        data_type: varchar
      
      - name: order_id
        description: "Order ID"
        data_type: varchar
        tests:
          - not_null
      
      - name: order_line
        description: "Order line number"
        data_type: number
      
      - name: order_key
        description: "Surrogate key (source_system|order_id|order_line)"
        data_type: varchar
        tests:
          - not_null
      
      # Order Details
      - name: order_number
        description: "Order number"
        data_type: varchar
      
      - name: order_date
        description: "Order date"
        data_type: date
      
      - name: order_quantity
        description: "Order quantity"
        data_type: number
      
      - name: order_amount
        description: "Order amount (local currency)"
        data_type: number
      
      - name: order_currency
        description: "Order currency code"
        data_type: varchar
      
      - name: order_status
        description: "Order status"
        data_type: varchar
      
      # Customer (Enriched)
      - name: customer_id
        description: "Customer ID"
        data_type: varchar
      
      - name: customer_name
        description: "Customer name (from DIM_CUSTOMER)"
        data_type: varchar
      
      - name: customer_type
        description: "Customer type (E=External, I=Internal)"
        data_type: varchar
      
      - name: customer_country
        description: "Customer country code"
        data_type: varchar
      
      - name: customer_country_name
        description: "Customer country name"
        data_type: varchar
      
      # Organizational
      - name: sales_org
        description: "Sales organization"
        data_type: varchar
      
      - name: profit_center
        description: "Profit center"
        data_type: varchar
      
      # Audit Columns (7 uniform columns)
      - name: dbt_run_id
        description: "dbt invocation ID"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_batch_id
        description: "Batch ID (unique per model per run)"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_loaded_at
        description: "Load timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_created_at
        description: "Record creation timestamp (= dbt_updated_at for views)"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_updated_at
        description: "Record update timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_source_model
        description: "Model name that created this record"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_environment
        description: "Target environment (dev/prod)"
        data_type: varchar
        tests:
          - not_null

  - name: stg_enriched_invoices
    description: |
      **Invoices with Payment Terms Enrichment**
      
      Joins FACT_INVOICES with DIM_PAYMENT_TERMS.
      
      **Pattern:** VIEW (always current)
      **Contract:** ENFORCED - Ensures column names and types match specification
      **Audit:** 7 columns (uniform set)
    access: protected
    config:
      tags: ['staging', 'invoices']
      contract:
        enforced: true
    columns:
      # Business Keys
      - name: source_system
        description: "Source ERP system"
        data_type: varchar
        tests:
          - not_null
      
      - name: company_code
        description: "Company code"
        data_type: varchar
      
      - name: invoice_id
        description: "Invoice ID"
        data_type: varchar
        tests:
          - not_null
      
      - name: invoice_line
        description: "Invoice line number"
        data_type: number
      
      - name: invoice_key
        description: "Surrogate key (source_system|invoice_id|invoice_line)"
        data_type: varchar
        tests:
          - not_null
      
      - name: order_id
        description: "Related order ID"
        data_type: varchar
      
      - name: order_line
        description: "Related order line"
        data_type: number
      
      - name: order_key
        description: "Related order key"
        data_type: varchar
        tests:
          - not_null
      
      # Invoice Details
      - name: invoice_number
        description: "Invoice number"
        data_type: varchar
      
      - name: invoice_date
        description: "Invoice date"
        data_type: date
      
      - name: posting_date
        description: "Posting date"
        data_type: date
      
      - name: invoice_quantity
        description: "Invoice quantity"
        data_type: number
      
      - name: invoice_amount
        description: "Invoice amount (local currency)"
        data_type: number
      
      - name: invoice_currency
        description: "Invoice currency code"
        data_type: varchar
      
      - name: invoice_status
        description: "Invoice status"
        data_type: varchar
      
      # Payment Terms (Enriched)
      - name: payment_terms_code
        description: "Payment terms code"
        data_type: varchar
      
      - name: payment_terms_name
        description: "Payment terms name (from DIM_PAYMENT_TERMS)"
        data_type: varchar
      
      - name: payment_terms_days
        description: "Payment terms days"
        data_type: number
      
      - name: calculated_due_date
        description: "Calculated due date"
        data_type: date
      
      # Audit Columns (7 uniform columns)
      - name: dbt_run_id
        description: "dbt invocation ID"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_batch_id
        description: "Batch ID (unique per model per run)"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_loaded_at
        description: "Load timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_created_at
        description: "Record creation timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_updated_at
        description: "Record update timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_source_model
        description: "Model name that created this record"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_environment
        description: "Target environment (dev/prod)"
        data_type: varchar
        tests:
          - not_null

  - name: stg_enriched_payments
    description: |
      **Payments with Bank Account Enrichment**
      
      Joins FACT_PAYMENTS with DIM_BANK_ACCOUNT.
      
      **Pattern:** VIEW (always current)
      **Contract:** ENFORCED - Ensures column names and types match specification
      **Audit:** 7 columns (uniform set)
    access: protected
    config:
      tags: ['staging', 'payments']
      contract:
        enforced: true
    columns:
      # Business Keys
      - name: source_system
        description: "Source ERP system"
        data_type: varchar
        tests:
          - not_null
      
      - name: company_code
        description: "Company code"
        data_type: varchar
      
      - name: payment_id
        description: "Payment ID"
        data_type: varchar
        tests:
          - not_null
      
      - name: payment_key
        description: "Surrogate key (source_system|payment_id)"
        data_type: varchar
        tests:
          - not_null
      
      - name: invoice_id
        description: "Related invoice ID"
        data_type: varchar
      
      - name: invoice_line
        description: "Related invoice line"
        data_type: number
      
      - name: invoice_key
        description: "Related invoice key"
        data_type: varchar
        tests:
          - not_null
      
      # Payment Details
      - name: payment_reference
        description: "Payment reference"
        data_type: varchar
      
      - name: payment_date
        description: "Payment date"
        data_type: date
      
      - name: clearing_date
        description: "Clearing date"
        data_type: date
      
      - name: payment_amount
        description: "Payment amount (local currency)"
        data_type: number
      
      - name: payment_currency
        description: "Payment currency code"
        data_type: varchar
      
      - name: payment_status
        description: "Payment status"
        data_type: varchar
      
      - name: cleared_flag
        description: "Payment cleared flag"
        data_type: boolean
      
      # Bank (Enriched)
      - name: bank_account_id
        description: "Bank account ID"
        data_type: varchar
      
      - name: bank_name
        description: "Bank name (from DIM_BANK_ACCOUNT)"
        data_type: varchar
      
      - name: bank_country
        description: "Bank country"
        data_type: varchar
      
      - name: bank_account_type
        description: "Bank account type"
        data_type: varchar
      
      # Audit Columns (7 uniform columns)
      - name: dbt_run_id
        description: "dbt invocation ID"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_batch_id
        description: "Batch ID (unique per model per run)"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_loaded_at
        description: "Load timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_created_at
        description: "Record creation timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_updated_at
        description: "Record update timestamp"
        data_type: timestamp_ntz
        tests:
          - not_null
      
      - name: dbt_source_model
        description: "Model name that created this record"
        data_type: varchar
        tests:
          - not_null
      
      - name: dbt_environment
        description: "Target environment (dev/prod)"
        data_type: varchar
        tests:
          - not_null

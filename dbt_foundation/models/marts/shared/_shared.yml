version: 2

models:
  - name: dim_customer
    description: "Shared customer dimension - published API for all domain projects"
    access: public
    config:
      contract:
        enforced: true
    
    columns:
      - name: customer_id
        description: "Unique customer identifier (composite of customer_num_sk + source_system)"
        data_type: varchar
        constraints:
          - type: not_null
          - type: primary_key
      
      - name: customer_num_sk
        description: "Customer number from source system"
        data_type: varchar
        constraints:
          - type: not_null
      
      - name: source_system
        description: "Source ERP system"
        data_type: varchar
        constraints:
          - type: not_null
      
      - name: customer_name
        description: "Customer legal name"
        data_type: varchar
      
      - name: customer_type
        description: "Customer type: E=External, I=Internal"
        data_type: varchar
      
      - name: customer_type_name
        description: "Customer type description"
        data_type: varchar
      
      - name: customer_classification
        description: "Customer classification name"
        data_type: varchar
      
      - name: customer_account_group
        description: "Customer account group"
        data_type: varchar
      
      - name: customer_country
        description: "Customer country code"
        data_type: varchar
      
      - name: customer_country_name
        description: "Customer country name"
        data_type: varchar
      
      - name: duns_number
        description: "D-U-N-S number from MDM"
        data_type: varchar
      
      - name: mdm_customer_full_name
        description: "Full customer name from MDM"
        data_type: varchar
      
      - name: global_ultimate_duns
        description: "Global ultimate D-U-N-S number"
        data_type: varchar
      
      - name: global_ultimate_name
        description: "Global ultimate company name"
        data_type: varchar
      
      - name: global_ultimate_parent_name
        description: "Global ultimate parent company name"
        data_type: varchar
      
      - name: ultimate_parent_source
        description: "Source of ultimate parent information"
        data_type: varchar
      
      - name: is_internal
        description: "Flag indicating if customer is internal Honeywell entity"
        data_type: boolean
      
      - name: load_ts
        description: "Timestamp when record was loaded into source"
        data_type: timestamp_ntz
      
      - name: update_ts
        description: "Timestamp when record was last updated in source"
        data_type: timestamp_ntz
      
      - name: _loaded_at
        description: "Timestamp when record was loaded into foundation"
        data_type: timestamp_ntz
    
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - customer_num_sk
            - source_system
      
      # dbt_expectations: Dimension quality checks
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 100  # At least 100 customers
          max_value: 10000000  # Up to 10M customers
          config:
            severity: warn
      
      # Check all customers have names
      - dbt_expectations.expect_column_values_to_not_be_null:
          column_name: customer_name
          config:
            severity: warn
            warn_if: ">5"  # Warn if >5 customers missing names
      
      # Validate customer_type values
      - dbt_expectations.expect_column_distinct_count_to_equal:
          column_name: customer_type
          value: 2  # Should only have 'E' and 'I'
          config:
            severity: error

  - name: dim_fiscal_calendar
    description: "Shared fiscal calendar - published API for all domain projects"
    access: public
    config:
      contract:
        enforced: true
    
    columns:
      - name: fiscal_day_key_str
        description: "Fiscal day key in YYYYMMDD format"
        data_type: varchar
        constraints:
          - type: not_null
          - type: primary_key
      
      - name: fiscal_date
        description: "Calendar date"
        data_type: date
        constraints:
          - type: not_null
      
      - name: fiscal_year_str
        description: "Fiscal year as string (YYYY)"
        data_type: varchar
      
      - name: fiscal_year_int
        description: "Fiscal year as integer"
        data_type: number
      
      - name: fiscal_period_str
        description: "Fiscal period as string (MM)"
        data_type: varchar
      
      - name: fiscal_period_int
        description: "Fiscal period as integer (1-12)"
        data_type: number
      
      - name: fiscal_year_period_str
        description: "Fiscal year-period as string (YYYY.MM)"
        data_type: varchar
      
      - name: fiscal_year_period_int
        description: "Fiscal year-period as integer (YYYYMM)"
        data_type: number
      
      - name: fiscal_year_quarter_str
        description: "Fiscal year-quarter as string (YYYY.Q#)"
        data_type: varchar
      
      - name: calendar_year
        description: "Calendar year"
        data_type: number
      
      - name: calendar_month
        description: "Calendar month (1-12)"
        data_type: number
      
      - name: calendar_day
        description: "Calendar day of month"
        data_type: number
      
      - name: day_of_week
        description: "Day of week"
        data_type: varchar
      
      - name: load_ts
        description: "Timestamp when record was loaded into source"
        data_type: timestamp_ntz
      
      - name: _loaded_at
        description: "Timestamp when record was loaded into foundation"
        data_type: timestamp_ntz
    
    tests:
      - dbt_utils.expression_is_true:
          expression: "fiscal_period_int between 1 and 12"
      - dbt_utils.expression_is_true:
          expression: "fiscal_year_int >= 2020"
      
      # dbt_expectations: Fiscal calendar quality checks
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 365  # At least 1 year of dates
          max_value: 7300  # Max 20 years of dates
          config:
            severity: warn
      
      # Validate fiscal period range
      - dbt_expectations.expect_column_values_to_be_between:
          column_name: fiscal_period_int
          min_value: 1
          max_value: 12
          config:
            severity: error
      
      # Validate fiscal year range
      - dbt_expectations.expect_column_values_to_be_between:
          column_name: fiscal_year_int
          min_value: 2020
          max_value: 2050
          config:
            severity: error
      
      # Check for gaps in dates (should be continuous)
      - dbt_expectations.expect_table_row_count_to_equal_other_table:
          compare_model: source('corp_ref', 'time_fiscal_day')
          config:
            severity: warn


version: 2

models:
  - name: dm_fin_ar_aging_simple
    description: "Simplified AR aging data mart - smallest isolated branch implementation"
    
    columns:
      - name: snapshot_date
        description: "Date of the aging snapshot"
        tests:
          - not_null
      
      - name: source_system
        description: "Source ERP system (BRP900, CIP900, CIP300, etc.)"
        tests:
          - not_null
          - accepted_values:
              values: ['BRP900', 'CIP900', 'CIP300', 'EEP300', 'P11', 'PRD010']
      
      - name: company_code
        description: "Company code (legal entity)"
        tests:
          - not_null
      
      - name: document_number
        description: "Invoice document number"
        tests:
          - not_null
      
      - name: document_line
        description: "Invoice line item"
        tests:
          - not_null
      
      - name: customer_number
        description: "Customer number from source system"
        tests:
          - not_null
      
      - name: customer_name
        description: "Customer name from dimension"
      
      - name: customer_type_flag
        description: "INTERNAL or EXTERNAL customer classification"
        tests:
          - accepted_values:
              values: ['INTERNAL', 'EXTERNAL']
      
      - name: amt_usd_me
        description: "Invoice amount in USD (month-end rate)"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          
          # dbt_expectations: Statistical validation
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000000  # $10M max per invoice line
              config:
                severity: error
          
          - dbt_expectations.expect_column_mean_to_be_between:
              min_value: 100
              max_value: 100000  # Average invoice should be $100-$100K
              config:
                severity: warn
      
      - name: posting_date
        description: "Date invoice was posted"
        tests:
          - not_null
      
      - name: due_date
        description: "Invoice due date"
        tests:
          - not_null
      
      - name: days_late
        description: "Number of days past due (negative = not yet due)"
        tests:
          - not_null
          
          # dbt_expectations: Reasonable range for days late
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: -365  # Up to 1 year early
              max_value: 1825  # Up to 5 years late
              config:
                severity: warn
      
      - name: aging_bucket
        description: "Aging category bucket"
        tests:
          - not_null
          - accepted_values:
              values: ['CURRENT', '1-30', '31-60', '61-90', '91-120', '121-150', '151-180', '181-360', '361+']
      
      - name: past_due_flag
        description: "YES if invoice is past due, NO otherwise"
        tests:
          - not_null
          - accepted_values:
              values: ['YES', 'NO']
      
      - name: current_amt
        description: "Amount if currently not past due"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      
      - name: past_due_amt
        description: "Amount if currently past due"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      
      - name: fiscal_year_period
        description: "Fiscal year-period (YYYY.MM)"
      
      - name: loaded_at
        description: "Timestamp when record was loaded"
        tests:
          - not_null
    
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - source_system
            - company_code
            - document_number
            - document_line
            - snapshot_date
      
      # Custom test: verify amounts reconcile
      - dbt_utils.expression_is_true:
          expression: "current_amt + past_due_amt = amt_usd_me"
          config:
            severity: warn
      
      # dbt_expectations: Table-level data quality checks
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1000  # Expect at least 1K AR records
          max_value: 10000000  # Up to 10M records
          config:
            severity: warn
      
      - dbt_expectations.expect_table_columns_to_match_ordered_list:
          column_list: 
            - snapshot_date
            - source_system
            - company_code
            - document_number
            - document_line
            - customer_number
            - customer_name
            - customer_type_flag
            - amt_usd_me
            - posting_date
            - due_date
            - days_late
            - aging_bucket
            - past_due_flag
            - current_amt
            - past_due_amt
            - fiscal_year_period
            - loaded_at
          config:
            severity: warn
      
      # Check for data freshness
      # Using dbt_utils recency test instead of dbt_expectations (compatibility)
      - dbt_utils.recency:
          datepart: day
          field: loaded_at
          interval: 1
          config:
            severity: error


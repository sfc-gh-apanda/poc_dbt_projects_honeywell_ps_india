version: 2

models:
  - name: dm_fin_ar_aging_simple
    description: "Simplified AR aging data mart - smallest isolated branch implementation"
    
    columns:
      - name: snapshot_date
        description: "Date of the aging snapshot"
        tests:
          - not_null
      
      - name: source_system
        description: "Source ERP system (BRP900, CIP900, CIP300, etc.)"
        tests:
          - not_null
          - accepted_values:
              values: ['BRP900', 'CIP900', 'CIP300', 'EEP300', 'P11', 'PRD010']
      
      - name: company_code
        description: "Company code (legal entity)"
        tests:
          - not_null
      
      - name: document_number
        description: "Invoice document number"
        tests:
          - not_null
      
      - name: document_line
        description: "Invoice line item"
        tests:
          - not_null
      
      - name: customer_number
        description: "Customer number from source system"
        tests:
          - not_null
      
      - name: customer_name
        description: "Customer name from dimension"
      
      - name: customer_type_flag
        description: "INTERNAL or EXTERNAL customer classification"
        tests:
          - accepted_values:
              values: ['INTERNAL', 'EXTERNAL']
      
      - name: amt_usd_me
        description: "Invoice amount in USD (month-end rate)"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      
      - name: posting_date
        description: "Date invoice was posted"
        tests:
          - not_null
      
      - name: due_date
        description: "Invoice due date"
        tests:
          - not_null
      
      - name: days_late
        description: "Number of days past due (negative = not yet due)"
        tests:
          - not_null
      
      - name: aging_bucket
        description: "Aging category bucket"
        tests:
          - not_null
          - accepted_values:
              values: ['CURRENT', '1-30', '31-60', '61-90', '91-120', '121-150', '151-180', '181-360', '361+']
      
      - name: past_due_flag
        description: "YES if invoice is past due, NO otherwise"
        tests:
          - not_null
          - accepted_values:
              values: ['YES', 'NO']
      
      - name: current_amt
        description: "Amount if currently not past due"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      
      - name: past_due_amt
        description: "Amount if currently past due"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      
      - name: fiscal_year_period
        description: "Fiscal year-period (YYYY.MM)"
      
      - name: loaded_at
        description: "Timestamp when record was loaded"
        tests:
          - not_null
    
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - source_system
            - company_code
            - document_number
            - document_line
            - snapshot_date
      
      # Custom test: verify amounts reconcile
      - dbt_utils.expression_is_true:
          expression: "current_amt + past_due_amt = amt_usd_me"
          config:
            severity: warn

